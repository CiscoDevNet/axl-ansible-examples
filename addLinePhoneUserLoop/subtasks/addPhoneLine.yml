---
- name: Add phone with line
  uri:
    url: "https://{{ ansible_host }}:8443/axl/"
    method: POST
    headers:
      Content-Type: text/xml
      SOAPAction: '"CUCM:DB ver=14.0 addPhone"'
    force_basic_auth: yes
    user: "{{ hostvars[ansible_host].axl_user }}"
    password: "{{ hostvars[ansible_host].axl_password }}"
    body_format: raw
    body: '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns="http://www.cisco.com/AXL/API/12.5">
            <soapenv:Header/>
            <soapenv:Body>
                <ns:addPhone sequence="1">
                  <phone>
                        <name>{{ item.phonename }}</name>
                        <product>{{ item.model }}</product>
                        <model>{{ item.model }}</model>
                        <class>Phone</class>
                        <protocol>SIP</protocol>
                        <protocolSide>User</protocolSide>
                        <callingSearchSpaceName/>
                        <devicePoolName>Default</devicePoolName>
                        <lines>
                          <line>
                            <dirn>
                              <pattern>{{ item.dn }}</pattern>
                              <routePartition>{{ item.partition }}</routePartition>
                            </dirn>
                            <index>1</index>
                          </line>
                        </lines>
                  </phone>
                </ns:addPhone>
            </soapenv:Body>
          </soapenv:Envelope>'
    validate_certs: false
    return_content: yes
    status_code: 200

